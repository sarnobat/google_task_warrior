<html>
<head>
<title>Not Now</title>
<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"> -->

<script src="jquery/jquery-1.9.1.js"></script>
<script type="text/javascript" src="jquery/purl.js"></script>

<script>
setInterval(function() {
	var defaultPostponement = determineDefaultPostponement();
	console.log("Default postponement is " + defaultPostponement);
	var incrementAll = determineIncrementAll();
	console.log("Increment all: " + incrementAll);
	populateBody(incrementAll, defaultPostponement);
    
}, 120 * 1000); // every 120 seconds

var messagesDeleted = 0;
var failures = 0;

$(document).ready(function(){	
	var defaultPostponement = determineDefaultPostponement();
	var incrementAll = determineIncrementAll();
	updateUrl(defaultPostponement, incrementAll);
	populateBody(incrementAll, defaultPostponement);
    
});

function determineDefaultPostponement() {
	var defaultPostponement;
	defaultPostponement = $.url().param('defaultPostponement');
	if (defaultPostponement == null || defaultPostponement == '') {
		defaultPostponement = 1;
	}
	return defaultPostponement;
}

function determineIncrementAll() {
	var incrementAll;
	incrementAll = $.url().param('incrementAll');
	if (incrementAll == null || incrementAll == '') {
		incrementAll = true;
	}
	return incrementAll;
}

function updateUrl(defaultPostponement, incrementAll) {
	history.pushState(null, null, '/not_now?defaultPostponement=' + defaultPostponement + '&incrementAll=' + incrementAll) // HTML5
}

function populateBody(incrementAll, defaultPostponement) {
	$.ajax("http://netgear.rohidekar.com:4456/not_now/items" )
	 .done(function(result) {
		console.log( "success" );
		populateCallback(result, incrementAll, defaultPostponement);
	  })
	  .fail(function() {
		console.log( "error" );
	  })
	  .always(function() {
		console.log( "complete" );
	  });
}

var tasks;

function populateCallback(result, incrementAll, defaultPostponement){
	$("#items").empty();
	$.each(result, function(i, field){
		var table = "";
		tasks = field;
		table +='<table id="taskRows">';
		table += getTaskRows(tasks, incrementAll, defaultPostponement);
		table +=	'</table>';
		$("#items").append(table);
	});
	console.debug('finished refreshing');
}

function getTaskRows(tasks, incrementAll, defaultPostponement) {
	var rows = "";
	$.each(tasks, function(k,v){
		if (k == 'daysToPostpone') {
			return;
		}
		var title = (v.title.split(/@/)[0]);
		var title2 = title.replace("Reminder: ","");
		if (v.title.match(/.*Repeating.*/)) {
			title2 = "[Repeating] " + title2;
		}
		rows +='<tr id=event-'+k+'>';
		var capitalizedTitle = capitalize(title2);
		var color = 'black';
		if (capitalizedTitle.match(/.*Repeating.*/)) {
			color = '#AAAAAA';
		}
		get_color: {
			var projects = ['yurl', 'coagulate'];
			$.each(projects, function(index, project) {
				if (capitalizedTitle.indexOf(project) != -1) {
				
					console.debug(project);
					console.debug(capitalizedTitle);
					color = '#BBBBBB';
				}
			});
		}
		{
			var projects = ['yurl', 'coagulate'];
			$.each(projects, function(index, project) {
				if (capitalizedTitle.indexOf(project) != -1) {
				
					console.debug(project);
					console.debug(capitalizedTitle);
					color = '#BBBBBB';
				}
			});
		}
		rows +='<td>' + k + "</td><td>&nbsp;</td><td style='color : "+color+"'>" + capitalizedTitle + "</td>";
		rows += "<td>&nbsp;<button type=button onclick='deleteEvent(" +k+")'>Delete</button>&nbsp;</td>";
		var quickPostponeAmounts = [0, 1, 2, 4, 8, 16, 32, 64];
		for(var i in quickPostponeAmounts) {
			var quickPostponeAmount;
			if (incrementAll) {
				quickPostponeAmount = parseInt(quickPostponeAmounts[i]) + parseInt(defaultPostponement);
			 } else {
				 quickPostponeAmount = quickPostponeAmounts[i];
			 }
			rows +="<td>&nbsp;&nbsp;<button type=button onclick='postponeDefault("+k+","+i+"," +defaultPostponement+ ","+ incrementAll + ")'> " +quickPostponeAmount + " days</button >"+"&nbsp;&nbsp;</td>";
		}
		//table +="<td>&nbsp;&nbsp;<button class=defaultpostpone type=button onclick='postponeDefault("+k+")'> " +defaultPostponement + " days</button >"+"&nbsp;&nbsp;</td>";
		rows +='</tr>';
	});	
	return rows;	
}


// Unused. Delete this
function postpone(itemNumber, daysToPostpone) {
	$.ajax( "http://netgear.rohidekar.com:4456/not_now/postpone?itemNumber=" + itemNumber + "&daysToPostpone=" + daysToPostpone)
	  .done(function() {
		  ++messagesDeleted;
		  $("#status").html(messagesDeleted);
		  delete tasks[itemNumber];
		  var table = getTaskRows(tasks, incrementAll, defaultPostponement);
		  $("#taskRows").html(table);
		console.log( "success" );
	  })
	  .fail(function() {
	  	++failures;
	    $("#failures").html(failures);
		console.log( "error" );
	  })
	  .always(function() {
		console.log( "complete" );
	  });
	  /*
    $.getJSON("http://netgear.rohidekar.com:4456/not_now/postpone?itemNumber=" + itemNumber + "&daysToPostpone=" + daysToPostpone,function(result){

    	console.log("success"); 
		++messagesDeleted;
    	$("#status").html(messagesDeleted);
    });*/
    $("#event-" + itemNumber).remove();
    
}

function deleteEvent(itemNumber) {
    $.ajax("http://netgear.rohidekar.com:4456/not_now/delete?itemNumber=" + itemNumber)
	  .done(function() {
		console.log( "success" );
		  ++messagesDeleted;
		  $("#status").html(messagesDeleted);
	  })
	  .fail(function() {
		console.log( "error" );
	  	++failures;
	    $("#failures").html(failures);
	  })
	  .always(function() {
		console.log( "complete" );
	  });

    $("#event-" + itemNumber).remove();
    
}

function postponeDefault(itemNumber, base, defaultPostponement, incrementAll) {
	var total = base + parseInt(defaultPostponement);
    $.ajax("http://netgear.rohidekar.com:4456/not_now/postpone?itemNumber=" + itemNumber + "&daysToPostpone=" + total)	  
      .done(function() {
		console.log( "success" );
		  ++messagesDeleted;
		  $("#status").html(messagesDeleted);
	  })
	  .fail(function() {
		console.log( "error" );
	  })
	  .always(function() {
		console.log( "complete" );
	  });

    $("#event-" + itemNumber).remove();
    defaultPostponement++;
    updateUrl(defaultPostponement, $.url().param('incrementAll'));
	//$(".defaultpostpone").text( defaultPostponement +  " days");
	//updateButtons();
	
	delete tasks[itemNumber];
	var table = getTaskRows(tasks, incrementAll, defaultPostponement);
	$("#taskRows").html(table);
}

function capitalize(str) {
    strVal = '';
    str = str.split(' ');
    for (var chr = 0; chr < str.length; chr++) {
        strVal += str[chr].substring(0, 1).toUpperCase() + str[chr].substring(1, str[chr].length) + ' '
    }
    return strVal
}

</script>
</head>
<body>
<div id="items">
Loading...
</div>
<br>
<span id="status">0</span> successes, <span id="failures">0</span> failures

</body>
</html>
